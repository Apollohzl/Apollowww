<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF在线转换 - 全能工具箱</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin: 30px 0;
            color: #2c3e50;
        }
        
        .intro {
            text-align: center;
            margin-bottom: 30px;
            color: #7f8c8d;
        }
        
        .converter-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .converter-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .converter-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .converter-card h3 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .converter-card p {
            color: #7f8c8d;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .tag {
            background: #e0f7fa;
            color: #00838f;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .file-input {
            width: 100%;
            margin-bottom: 15px;
        }
        
        .convert-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
            width: 100%;
        }
        
        .convert-btn:hover {
            background: #2980b9;
        }
        
        .download-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
            width: 100%;
            margin-top: 10px;
            display: none;
        }
        
        .download-btn:hover {
            background: #27ae60;
        }
        
        .progress-container {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #4CAF50;
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
        }
        /* 文件上传区域样式 */
        .upload-area {
            width: 100%;
            height: 150px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s;
            background-color: rgba(52, 152, 219, 0.05);
        }

        .upload-area:hover {
            background-color: rgba(52, 152, 219, 0.1);
            border-color: #2980b9;
        }

        .upload-area.active {
            border-color: #2ecc71;
            background-color: rgba(46, 204, 113, 0.1);
        }

        .upload-icon {
            font-size: 2.5rem;
            color: #3498db;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #7f8c8d;
            font-size: 1rem;
        }

        .upload-text strong {
            color: #3498db;
        }

        .upload-filename {
            margin-top: 10px;
            color: #2c3e50;
            font-size: 0.9rem;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 进度条样式 */
        .upload-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s;
            border-radius: 0 0 6px 6px;
        }

        /* 隐藏原始文件输入 */
        .file-input-hidden {
            display: none;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px 0;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }
            
            .converter-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>PDF在线转换工具</h1>
    <p class="intro">无需上传服务器，直接在浏览器中完成PDF转换操作，保护您的隐私安全</p>
    
    <div class="converter-container">
        <!-- PDF转Word -->
        <div class="converter-card">
            <h3>PDF转Word</h3>
            <p>将PDF文档转换为可编辑的Word格式</p>
            <div class="tags">
                <span class="tag">pdf</span>
                <span class="tag">docx</span>
                <span class="tag">转换</span>
            </div>
                <!-- 新的上传区域 -->
            <div class="upload-area" id="pdfToWordUpload">
                <div class="upload-icon">📄</div>
                <div class="upload-text">点击或拖拽文件到此处<br><strong>支持PDF文件</strong></div>
                <div class="upload-filename" id="pdfToWordFilename"></div>
                <div class="upload-progress" id="pdfToWordUploadProgress"></div>
            </div>
            <input type="file" class="file-input" id="pdfToWordInput" accept=".pdf">
            <button class="convert-btn" id="pdfToWordBtn">开始转换</button>
            <button class="download-btn" id="pdfToWordDownload">下载Word文件</button>
            <div class="progress-container" id="pdfToWordProgress">
                <div class="progress-bar" id="pdfToWordProgressBar"></div>
            </div>
        </div>
        
        <!-- Word转PDF -->
        <div class="converter-card">
            <h3>Word转PDF</h3>
            <p>将Word文档转换为PDF格式</p>
            <div class="tags">
                <span class="tag">docx</span>
                <span class="tag">pdf</span>
                <span class="tag">转换</span>
            </div>
            <!-- 新的上传区域 -->
            <div class="upload-area" id="wordToPdfUpload">
                <div class="upload-icon">📄</div>
                <div class="upload-text">点击或拖拽文件到此处<br><strong>支持PDF文件</strong></div>
                <div class="upload-filename" id="wordToPdfFilename"></div>
                <div class="upload-progress" id="wordToPdfUploadProgress"></div>
            </div>
            <input type="file" class="file-input" id="wordToPdfInput" accept=".doc,.docx">
            <button class="convert-btn" id="wordToPdfBtn">开始转换</button>
            <button class="download-btn" id="wordToPdfDownload">下载PDF文件</button>
            <div class="progress-container" id="wordToPdfProgress">
                <div class="progress-bar" id="wordToPdfProgressBar"></div>
            </div>
        </div>
        
        <!-- PDF转图片 -->
        <div class="converter-card">
            <h3>PDF转图片</h3>
            <p>将PDF文档转换为图片(JPG/PNG)</p>
            <div class="tags">
                <span class="tag">pdf</span>
                <span class="tag">图片</span>
                <span class="tag">转换</span>
            </div>
            <!-- 新的上传区域 -->
            <div class="upload-area" id="pdfToImageUpload">
                <div class="upload-icon">📄</div>
                <div class="upload-text">点击或拖拽文件到此处<br><strong>支持PDF文件</strong></div>
                <div class="upload-filename" id="pdfToImageFilename"></div>
                <div class="upload-progress" id="pdfToImageUploadProgress"></div>
            </div>
            <input type="file" class="file-input" id="pdfToImageInput" accept=".pdf">
            <select id="imageFormat" style="width:100%; margin-bottom:15px; padding:8px;">
                <option value="jpg">JPG格式</option>
                <option value="png">PNG格式</option>
            </select>
            <button class="convert-btn" id="pdfToImageBtn">开始转换</button>
            <div id="imagePreview" style="margin-top:15px;"></div>
        </div>
        
        <!-- 图片转PDF -->
        <div class="converter-card">
            <h3>图片转PDF</h3>
            <p>将多张图片合并为一个PDF文档</p>
            <div class="tags">
                <span class="tag">图片</span>
                <span class="tag">pdf</span>
                <span class="tag">合并</span>
            </div>
            <!-- 新的上传区域 -->
            <div class="upload-area" id="imageToPdfUpload">
                <div class="upload-icon">📄</div>
                <div class="upload-text">点击或拖拽文件到此处<br><strong>支持PDF文件</strong></div>
                <div class="upload-filename" id="imageToPdfFilename"></div>
                <div class="upload-progress" id="imageToPdfUploadProgress"></div>
            </div>
            <input type="file" class="file-input" id="imageToPdfInput" accept="image/*" multiple>
            <button class="convert-btn" id="imageToPdfBtn">开始转换</button>
            <button class="download-btn" id="imageToPdfDownload">下载PDF文件</button>
            <div class="progress-container" id="imageToPdfProgress">
                <div class="progress-bar" id="imageToPdfProgressBar"></div>
            </div>
        </div>
        
        <!-- PDF合并 -->
        <div class="converter-card">
            <h3>PDF合并</h3>
            <p>将多个PDF文档合并为一个</p>
            <div class="tags">
                <span class="tag">pdf</span>
                <span class="tag">合并</span>
            </div>
            <!-- 新的上传区域 -->
            <div class="upload-area" id="pdfMergeUpload">
                <div class="upload-icon">📄</div>
                <div class="upload-text">点击或拖拽文件到此处<br><strong>支持PDF文件</strong></div>
                <div class="upload-filename" id="pdfMergeFilename"></div>
                <div class="upload-progress" id="pdfMergeUploadProgress"></div>
            </div>
            <input type="file" class="file-input" id="pdfMergeInput" accept=".pdf" multiple>
            <button class="convert-btn" id="pdfMergeBtn">开始合并</button>
            <button class="download-btn" id="pdfMergeDownload">下载合并文件</button>
            <div class="progress-container" id="pdfMergeProgress">
                <div class="progress-bar" id="pdfMergeProgressBar"></div>
            </div>
        </div>
        
        <!-- PDF拆分 -->
        <div class="converter-card">
            <h3>PDF拆分</h3>
            <p>将一个PDF文档拆分为多个</p>
            <div class="tags">
                <span class="tag">pdf</span>
                <span class="tag">拆分</span>
            </div>
            <!-- 新的上传区域 -->
            <div class="upload-area" id="pdfSplitUpload">
                <div class="upload-icon">📄</div>
                <div class="upload-text">点击或拖拽文件到此处<br><strong>支持PDF文件</strong></div>
                <div class="upload-filename" id="pdfSplitFilename"></div>
                <div class="upload-progress" id="pdfSplitUploadProgress"></div>
            </div>
            <input type="file" class="file-input" id="pdfSplitInput" accept=".pdf">
            <div style="margin:10px 0;">
                <label for="splitRange">拆分页面范围(如1-3,5,7-9):</label>
                <input type="text" id="splitRange" style="width:100%; padding:8px;" placeholder="1-3,5,7-9">
            </div>
            <button class="convert-btn" id="pdfSplitBtn">开始拆分</button>
            <div id="splitDownloads" style="margin-top:15px;"></div>
        </div>
        
        <!-- PDF压缩 -->
        <div class="converter-card">
            <h3>PDF压缩</h3>
            <p>减小PDF文件大小，保持质量</p>
            <div class="tags">
                <span class="tag">pdf</span>
                <span class="tag">压缩</span>
                <span class="tag">优化</span>
            </div>
            <!-- 新的上传区域 -->
            <div class="upload-area" id="pdfCompressUpload">
                <div class="upload-icon">📄</div>
                <div class="upload-text">点击或拖拽文件到此处<br><strong>支持PDF文件</strong></div>
                <div class="upload-filename" id="pdfCompressFilename"></div>
                <div class="upload-progress" id="pdfCompressUploadProgress"></div>
            </div>
            <input type="file" class="file-input" id="pdfCompressInput" accept=".pdf">
            <select id="compressLevel" style="width:100%; margin-bottom:15px; padding:8px;">
                <option value="1">低压缩(高质量)</option>
                <option value="2" selected>中等压缩(平衡)</option>
                <option value="3">高压缩(小文件)</option>
            </select>
            <button class="convert-btn" id="pdfCompressBtn">开始压缩</button>
            <button class="download-btn" id="pdfCompressDownload">下载压缩文件</button>
            <div class="progress-container" id="pdfCompressProgress">
                <div class="progress-bar" id="pdfCompressProgressBar"></div>
            </div>
        </div>
        
        <!-- PDF加密/解密 -->
        <div class="converter-card">
            <h3>PDF加密/解密</h3>
            <p>为PDF添加密码保护或移除密码</p>
            <div class="tags">
                <span class="tag">pdf</span>
                <span class="tag">安全</span>
                <span class="tag">加密</span>
            </div>
            <!-- 新的上传区域 -->
            <div class="upload-area" id="pdfSecurityUpload">
                <div class="upload-icon">📄</div>
                <div class="upload-text">点击或拖拽文件到此处<br><strong>支持PDF文件</strong></div>
                <div class="upload-filename" id="pdfSecurityFilename"></div>
                <div class="upload-progress" id="pdfSecurityUploadProgress"></div>
            </div>
            <input type="file" class="file-input" id="pdfSecurityInput" accept=".pdf">
            <select id="securityAction" style="width:100%; margin-bottom:15px; padding:8px;">
                <option value="encrypt">加密PDF</option>
                <option value="decrypt">解密PDF(需密码)</option>
            </select>
            <input type="password" id="pdfPassword" style="width:100%; padding:8px; margin-bottom:15px;" placeholder="输入密码">
            <button class="convert-btn" id="pdfSecurityBtn">开始处理</button>
            <button class="download-btn" id="pdfSecurityDownload">下载处理文件</button>
            <div class="progress-container" id="pdfSecurityProgress">
                <div class="progress-bar" id="pdfSecurityProgressBar"></div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>copyright © 2025 全能工具箱 | 为您提供便捷的在线工具服务</p>
    </footer>

    <!-- 引入必要的JS库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js"></script>
    
    <script>
        // 初始化PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
        // 为所有上传区域添加拖放功能
        function setupUploadArea(uploadAreaId, inputId, filenameId, progressId) {
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInput = document.getElementById(inputId);
            const filenameDisplay = document.getElementById(filenameId);
            const progressBar = document.getElementById(progressId);
            
            // 点击事件
            uploadArea.addEventListener('click', () => fileInput.click());
            
            // 拖放事件
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('active');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('active');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('active');
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    updateFilenameDisplay();
                }
            });
            
            // 文件选择变化事件
            fileInput.addEventListener('change', updateFilenameDisplay);
            
            function updateFilenameDisplay() {
                if (fileInput.files.length) {
                    const file = fileInput.files[0];
                    filenameDisplay.textContent = file.name;
                    progressBar.style.width = '100%'; // 选择文件后立即显示完整进度条
                } else {
                    filenameDisplay.textContent = '';
                    progressBar.style.width = '0%';
                }
            }
            
            // 返回进度更新函数
            return function(progress) {
                progressBar.style.width = `${progress}%`;
            };
        }

        // 初始化所有上传区域
        const updatePdfToWordProgress = setupUploadArea(
            'pdfToWordUpload', 
            'pdfToWordInput', 
            'pdfToWordFilename', 
            'pdfToWordUploadProgress'
        );

        const updateWordToPdfProgress = setupUploadArea(
            'wordToPdfUpload', 
            'wordToPdfInput', 
            'wordToPdfFilename', 
            'wordToPdfUploadProgress'
        );

        const updatePdfToImageProgress = setupUploadArea(
            'pdfToImageUpload', 
            'pdfToImageInput', 
            'pdfToImageFilename', 
            'pdfToImageUploadProgress'
        );


        const updatePdfMergeProgress = setupUploadArea(
            'pdfMergeUpload', 
            'pdfMergeInput', 
            'pdfMergeFilename', 
            'pdfMergeUploadProgress'
        );

        const updatePdfSplitProgress = setupUploadArea(
            'pdfSplitUpload', 
            'pdfSplitInput', 
            'pdfSplitFilename', 
            'pdfSplitUploadProgress'
        );
        const updatePdfCompressProgress = setupUploadArea(
            'pdfCompressUpload', 
            'pdfCompressInput', 
            'pdfCompressFilename', 
            'pdfCompressUploadProgress'
        );

        const updatePdfSecurityProgress = setupUploadArea(
            'pdfSecurityUpload', 
            'pdfSecurityInput', 
            'pdfSecurityFilename', 
            'pdfSecurityUploadProgress'
        );
        // 其他转换器的上传区域也需要类似初始化...
        // 初始化图片转PDF上传区域(支持多文件)
        function setupMultiFileUpload(uploadAreaId, inputId, filenameId, progressId) {
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInput = document.getElementById(inputId);
            const filenameDisplay = document.getElementById(filenameId);
            const progressBar = document.getElementById(progressId);
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('active');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('active');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('active');
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    updateFilenameDisplay();
                }
            });
            
            fileInput.addEventListener('change', updateFilenameDisplay);
            
            function updateFilenameDisplay() {
                if (fileInput.files.length) {
                    const files = fileInput.files;
                    if (files.length === 1) {
                        filenameDisplay.textContent = files[0].name;
                    } else {
                        filenameDisplay.textContent = `${files.length}个文件已选择`;
                    }
                    progressBar.style.width = '100%';
                } else {
                    filenameDisplay.textContent = '';
                    progressBar.style.width = '0%';
                }
            }
            
            return function(progress) {
                progressBar.style.width = `${progress}%`;
            };
        }

        // 初始化多文件上传区域(如图片转PDF)
        const updateImageToPdfProgress = setupMultiFileUpload(
            'imageToPdfUpload',
            'imageToPdfInput',
            'imageToPdfFilename',
            'imageToPdfUploadProgress'
        );
        // PDF转Word
        document.getElementById('pdfToWordBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('pdfToWordInput');
            if (!fileInput.files.length) {
                alert('请先选择PDF文件');
                return;
            }
            
            const file = fileInput.files[0];
            const progress = document.getElementById('pdfToWordProgress');
            const progressBar = document.getElementById('pdfToWordProgressBar');
            
            progress.style.display = 'block';
            progressBar.style.width = '0%';
            
            try {
                // 这里应该有实际的PDF转Word逻辑
                // 由于纯前端PDF转Word比较复杂，这里只是模拟
                progressBar.style.width = '30%';
                await new Promise(resolve => setTimeout(resolve, 500));
                progressBar.style.width = '60%';
                await new Promise(resolve => setTimeout(resolve, 500));
                progressBar.style.width = '100%';
                
                // 模拟生成Word文件
                const { Document, Paragraph, Packer } = docx;
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: [
                            new Paragraph({
                                text: "这是从PDF转换而来的Word文档",
                                heading: "Heading1"
                            }),
                            new Paragraph({
                                text: "由于纯前端PDF转Word比较复杂，这里只是演示",
                                heading: "Heading2"
                            })
                        ]
                    }]
                });
                
                const blob = await Packer.toBlob(doc);
                const downloadBtn = document.getElementById('pdfToWordDownload');
                downloadBtn.style.display = 'block';
                downloadBtn.onclick = function() {
                    saveAs(blob, 'converted.docx');
                };
                
            } catch (error) {
                console.error(error);
                alert('转换失败: ' + error.message);
            }
        });
        
        // Word转PDF
        document.getElementById('wordToPdfBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('wordToPdfInput');
            if (!fileInput.files.length) {
                alert('请先选择Word文件');
                return;
            }
            
            const file = fileInput.files[0];
            const progress = document.getElementById('wordToPdfProgress');
            const progressBar = document.getElementById('wordToPdfProgressBar');
            
            progress.style.display = 'block';
            progressBar.style.width = '0%';
            
            try {
                // 这里应该有实际的Word转PDF逻辑
                // 由于纯前端Word转PDF比较复杂，这里只是模拟
                progressBar.style.width = '30%';
                await new Promise(resolve => setTimeout(resolve, 500));
                progressBar.style.width = '60%';
                await new Promise(resolve => setTimeout(resolve, 500));
                progressBar.style.width = '100%';
                
                // 模拟生成PDF文件
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('这是从Word转换而来的PDF文档', 10, 10);
                doc.text('由于纯前端Word转PDF比较复杂，这里只是演示', 10, 20);
                
                const pdfBlob = doc.output('blob');
                const downloadBtn = document.getElementById('wordToPdfDownload');
                downloadBtn.style.display = 'block';
                downloadBtn.onclick = function() {
                    saveAs(pdfBlob, 'converted.pdf');
                };
                
            } catch (error) {
                console.error(error);
                alert('转换失败: ' + error.message);
            }
        });
        
        // PDF转图片
        document.getElementById('pdfToImageBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('pdfToImageInput');
            if (!fileInput.files.length) {
                alert('请先选择PDF文件');
                return;
            }
            
            const file = fileInput.files[0];
            const format = document.getElementById('imageFormat').value;
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '<p>正在转换...</p>';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                const pdf = await loadingTask.promise;
                
                preview.innerHTML = '';
                
                // 转换每一页为图片
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    const imgData = canvas.toDataURL(`image/${format}`);
                    const img = document.createElement('img');
                    img.src = imgData;
                    img.style.maxWidth = '100%';
                    img.style.marginBottom = '10px';
                    img.style.display = 'block';
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = imgData;
                    downloadLink.download = `page_${i}.${format}`;
                    downloadLink.textContent = `下载第${i}页`;
                    downloadLink.style.display = 'block';
                    downloadLink.style.marginBottom = '20px';
                    downloadLink.style.color = '#3498db';
                    
                    const container = document.createElement('div');
                    container.appendChild(img);
                    container.appendChild(downloadLink);
                    preview.appendChild(container);
                }
                
            } catch (error) {
                console.error(error);
                preview.innerHTML = '<p style="color:red;">转换失败: ' + error.message + '</p>';
            }
        });
        
        // 图片转PDF
        document.getElementById('imageToPdfBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('imageToPdfInput');
            if (!fileInput.files.length) {
                alert('请先选择图片文件');
                return;
            }
            
            const files = Array.from(fileInput.files);
            const progress = document.getElementById('imageToPdfProgress');
            const progressBar = document.getElementById('imageToPdfProgressBar');
            
            progress.style.display = 'block';
            progressBar.style.width = '0%';
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const img = await createImageBitmap(file);
                    
                    if (i > 0) doc.addPage();
                    
                    const imgWidth = doc.internal.pageSize.getWidth() - 20;
                    const imgHeight = (img.height * imgWidth) / img.width;
                    
                    doc.addImage(img, 'JPEG', 10, 10, imgWidth, imgHeight);
                    
                    progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                const pdfBlob = doc.output('blob');
                const downloadBtn = document.getElementById('imageToPdfDownload');
                downloadBtn.style.display = 'block';
                downloadBtn.onclick = function() {
                    saveAs(pdfBlob, 'converted.pdf');
                };
                
            } catch (error) {
                console.error(error);
                alert('转换失败: ' + error.message);
            }
        });
        
        // PDF合并
        document.getElementById('pdfMergeBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('pdfMergeInput');
            if (!fileInput.files.length || fileInput.files.length < 2) {
                alert('请至少选择2个PDF文件');
                return;
            }
            
            const files = Array.from(fileInput.files);
            const progress = document.getElementById('pdfMergeProgress');
            const progressBar = document.getElementById('pdfMergeProgressBar');
            
            progress.style.display = 'block';
            progressBar.style.width = '0%';
            
            try {
                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.create();
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const arrayBuffer = await file.arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    
                    const pages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                    pages.forEach(page => mergedPdf.addPage(page));
                    
                    progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                const mergedPdfBytes = await mergedPdf.save();
                const mergedPdfBlob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                
                const downloadBtn = document.getElementById('pdfMergeDownload');
                downloadBtn.style.display = 'block';
                downloadBtn.onclick = function() {
                    saveAs(mergedPdfBlob, 'merged.pdf');
                };
                
            } catch (error) {
                console.error(error);
                alert('合并失败: ' + error.message);
            }
        });
        
        // PDF拆分
        document.getElementById('pdfSplitBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('pdfSplitInput');
            if (!fileInput.files.length) {
                alert('请先选择PDF文件');
                return;
            }
            
            const rangeText = document.getElementById('splitRange').value.trim();
            if (!rangeText) {
                alert('请输入要拆分的页面范围');
                return;
            }
            
            const file = fileInput.files[0];
            const downloadsContainer = document.getElementById('splitDownloads');
            downloadsContainer.innerHTML = '<p>正在处理...</p>';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const { PDFDocument } = PDFLib;
                const pdfDoc = await PDFDocument.load(arrayBuffer);
                const pageCount = pdfDoc.getPageCount();
                
                // 解析页面范围
                const ranges = rangeText.split(',');
                const pageSets = [];
                
                for (const range of ranges) {
                    if (range.includes('-')) {
                        const [start, end] = range.split('-').map(Number);
                        for (let i = start; i <= end; i++) {
                            if (i >= 1 && i <= pageCount) {
                                pageSets.push([i]);
                            }
                        }
                    } else {
                        const pageNum = Number(range);
                        if (pageNum >= 1 && pageNum <= pageCount) {
                            pageSets.push([pageNum]);
                        }
                    }
                }
                
                if (pageSets.length === 0) {
                    alert('没有有效的页面范围');
                    return;
                }
                
                downloadsContainer.innerHTML = '';
                
                for (const pages of pageSets) {
                    const newPdf = await PDFDocument.create();
                    const copiedPages = await newPdf.copyPages(pdfDoc, pages.map(p => p - 1));
                    copiedPages.forEach(page => newPdf.addPage(page));
                    
                    const pdfBytes = await newPdf.save();
                    const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = URL.createObjectURL(pdfBlob);
                    downloadLink.download = `page_${pages.join('_')}.pdf`;
                    downloadLink.textContent = `下载页面 ${pages.join(', ')}`;
                    downloadLink.style.display = 'block';
                    downloadLink.style.marginBottom = '10px';
                    downloadLink.style.color = '#3498db';
                    
                    downloadsContainer.appendChild(downloadLink);
                }
                
            } catch (error) {
                console.error(error);
                downloadsContainer.innerHTML = '<p style="color:red;">拆分失败: ' + error.message + '</p>';
            }
        });
        
        // PDF压缩
        document.getElementById('pdfCompressBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('pdfCompressInput');
            if (!fileInput.files.length) {
                alert('请先选择PDF文件');
                return;
            }
            
            const file = fileInput.files[0];
            const level = document.getElementById('compressLevel').value;
            const progress = document.getElementById('pdfCompressProgress');
            const progressBar = document.getElementById('pdfCompressProgressBar');
            
            progress.style.display = 'block';
            progressBar.style.width = '0%';
            
            try {
                // 模拟压缩过程
                progressBar.style.width = '30%';
                await new Promise(resolve => setTimeout(resolve, 500));
                progressBar.style.width = '60%';
                await new Promise(resolve => setTimeout(resolve, 500));
                progressBar.style.width = '100%';
                
                // 在实际应用中，这里应该有实际的PDF压缩逻辑
                // 由于纯前端PDF压缩比较复杂，这里只是模拟
                const arrayBuffer = await file.arrayBuffer();
                const { PDFDocument } = PDFLib;
                const pdfDoc = await PDFDocument.load(arrayBuffer);
                
                // 模拟不同压缩级别
                let saveOptions = {};
                if (level === '1') {
                    saveOptions = { useObjectStreams: false };
                } else if (level === '3') {
                    saveOptions = { useObjectStreams: true, compressImages: true, imageQuality: 0.5 };
                } else {
                    saveOptions = { useObjectStreams: true, compressImages: true, imageQuality: 0.75 };
                }
                
                const pdfBytes = await pdfDoc.save(saveOptions);
                const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                const downloadBtn = document.getElementById('pdfCompressDownload');
                downloadBtn.style.display = 'block';
                downloadBtn.onclick = function() {
                    saveAs(pdfBlob, 'compressed.pdf');
                };
                
            } catch (error) {
                console.error(error);
                alert('压缩失败: ' + error.message);
            }
        });
        
        // PDF加密/解密
        document.getElementById('pdfSecurityBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('pdfSecurityInput');
            if (!fileInput.files.length) {
                alert('请先选择PDF文件');
                return;
            }
            
            const action = document.getElementById('securityAction').value;
            const password = document.getElementById('pdfPassword').value;
            
            if (action === 'encrypt' && !password) {
                alert('请设置密码');
                return;
            }
            
            const file = fileInput.files[0];
            const progress = document.getElementById('pdfSecurityProgress');
            const progressBar = document.getElementById('pdfSecurityProgressBar');
            
            progress.style.display = 'block';
            progressBar.style.width = '0%';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const { PDFDocument } = PDFLib;
                const pdfDoc = await PDFDocument.load(arrayBuffer);
                
                progressBar.style.width = '50%';
                
                if (action === 'encrypt') {
                    // 加密PDF
                    pdfDoc.setUserPassword(password);
                    pdfDoc.setUserAccessPermissions([PDFDocument.UserAccessPermissions.Printing]);
                } else {
                    // 解密PDF
                    try {
                        await pdfDoc.setUserPassword(password);
                    } catch (error) {
                        if (error.message.includes('Incorrect password')) {
                            throw new Error('密码不正确');
                        }
                        throw error;
                    }
                }
                
                progressBar.style.width = '100%';
                const pdfBytes = await pdfDoc.save();
                const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                const downloadBtn = document.getElementById('pdfSecurityDownload');
                downloadBtn.style.display = 'block';
                downloadBtn.onclick = function() {
                    saveAs(pdfBlob, action === 'encrypt' ? 'encrypted.pdf' : 'decrypted.pdf');
                };
                
            } catch (error) {
                console.error(error);
                alert('处理失败: ' + error.message);
            }
        });
    </script>
</body>
</html>